<!DOCTYPE html>
	<head>
		<meta charset="UTF-8">
		<title>machine</title>
		<link rel="icon" type="image/png" href="Image/icon.png">
		<link rel="stylesheet" href="MachineStyle.css">
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<style>
		</style>
	</head>
	
	<body>
		<h1 class="text shadow"
			style="	text-transform: uppercase;
					font-size: clamp(10px, 5vw, 60px);
					">
			Üdvözöllek a motor irányító központban
		</h1>
		<div class="middle">
			<p class="text textborder text-box">Imáid továbbítva lettek,<br>de ez még nem jelent semmit!</p>
		</div>
		
		<div style="display: flex;
					justify-content: space-between;		
					margin-top: 50px;
					
					height: 500px;
					max-height: 100vh;">
			<div 	style="	width:49%;
							margin: 10px;
							display: flex;
							justify-content: space-between;"
					class="div-background">
						<button class="buttonBig"
								style="	flex:0.45;
										"
								onclick="ledOn()"
									>Turn<br>ON LED
						</button>
						<button class="buttonBig"
								style="	flex:0.45;
										"
								onclick="ledOff()"
									>Turn<br>OFF LED
						</button>
			</div>
			<div 	style="	width:49%;
							margin: 10px;"
					class="div-background">
				<canvas id="MyChart" 
						heigth="1000" 
						width="1000"
						class="chartMachine"
						style="	width: 100%;
								height: 100%;
								max-height: 100vh;
								"
							>
				</canvas>
			</div>
		</div>
		
		
		
		
		<script>
		  //Először is hadd kezdjem azzal, hogy mi az, hogy nem kell megadni változónak a típusát?! Mi az hogy dinamikusan adja meg a típusát programfutása közben?!
		  let ip = window.location.hostname; //A böngésződben megnyitott ablak url címéből kiszedi az IP cím részt, amelyet később felhasználhatsz.
		  console.log("Az esp32 IP-címe:", ip); //Kírja a konzolba, amelyet F12-vel tudsz elérni.
		  
		  async function ledOn() { //Ha ez megvan akkor a ledOff-ot nem is kell majd részletezni.
			let bodyjson = "{\"code\":\"107\"}"; //Létrehoz egy JSON objektumot "code" kulcsszóval és 107-es értéket rendel hozzá.
			let url = "/ledOn"; //Létrehoz egy stringet "/ledOn" névvel, amely majd a végpont lesz.

			let response = await fetch(url, { //Létrehoz egy response-t, amely a fetch értékét fogja tárolni. Az await-el a kód addig meg áll és nem megy tovább, amíg a fetch be nem fejeződik.
			  //Mi is ez a fetch? 
			  
			  //A fetch itt lesz konfigurálva
			  method: 'POST', //Megadja a HTTP metódust. POST - azaz innen küldünk ki értéket.
			  body: bodyjson, //A küldeni kívánt változó neve. 
			  headers: {
				'Access-Control-Allow-Headers': '*',
				'Access-Control-Allow-Origin': '*',
				'Content-type': 'application/json; charset=UTF-8' //Innen fogja tudni a szerver, hogy JSON formátumban akarunk küldeni adatot.
			  }
			}).catch(err => { alert(err); });

			let ret = await response.text();
			let ret_json = JSON.parse(ret);

			if (ret_json['success'] === 1)
			  document.getElementById("feedback").value = "LED has been turned ON";
			else
			  document.getElementById("feedback").value = "LED is already turned ON";
		  }
		  async function ledOff() {
			let bodyjson = "{\"code\":\"105\"}";
			let url = "/ledOn";

			let response = await fetch(url, {
			  method: 'POST',
			  body: bodyjson,
			  headers: {
				'Access-Control-Allow-Headers': '*',
				'Access-Control-Allow-Origin': '*',
				'Content-type': 'application/json; charset=UTF-8'
			  }
			}).catch(err => { alert(err); });

			let ret = await response.text();
			let ret_json = JSON.parse(ret);

			if (ret_json['success'] === 1)
			  document.getElementById("feedback").value = "LED has been turned OFF";
			else
			  document.getElementById("feedback").value = "LED is already turned OFF";
		  }
		  async function getAdc() {
		  url = ip + "/getAdc";
		  let response = await fetch(url).catch(err =>
		  { alert(err); })
		  let text = await response.text();
		  let adcval = JSON.parse(text)
		  document.getElementById("state").value =
		  adcval['value'];
		  
		  // Hozzáadjuk az új értéket a charthoz
			const now = new Date().toLocaleTimeString();
			adcChart.data.labels.push(now);
			adcChart.data.datasets[0].data.push(adcval['value']);

			// Ha túl sok adat van, törlünk a legelejéről
			if (adcChart.data.labels.length > 20) {
			  adcChart.data.labels.shift();
			  adcChart.data.datasets[0].data.shift();
			}

			adcChart.update();
		  
		  
		  
		  }
			
			// Chart inicializálása
			const chartVar = document.getElementById('MyChart').getContext('2d');
			const motorChart = new Chart(chartVar, {
			  type: 'line',
			  data: {
				labels: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
				datasets: [{
				  label: 'Motor position',
				  data: [500, 750, 1000, 1250, 1500, 2000, 3000, 3500, 3750, 4000],
				  borderColor: 'rgba(96, 0, 0, 1)',
				  backgroundColor: 'rgba(144, 0, 0, 1)',
				  fill: false,
				  tension: 0,
				}]
			  },
			  options: {
				responsive: true,
				animation: false,
				scales: {
				  x: {
					type: 'category',
					title: {
					  display: true,
					  text: 'eltelt idő',
					},
					grid: {
					  display: true,
					},
				  },
				  y: {
					beginAtZero: true,
					title: {
					  display: true,
					  text: 'pozíció érték',
					},
				  },
				},
			  }
			});		
			
		//setInterval(getAdc, 1000);
	</script>
		
	</body>
</html>